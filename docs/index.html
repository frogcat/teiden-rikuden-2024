<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>teiden-rikuden-2024</title>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <style>
      #map {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
      }
      #ctrl {
        position: absolute;
        top: 5px;
        right: 5px;
        width: auto;
        height: auto;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        z-index: 2000;
        color: white;
      }
    </style>
  </head>

  <body>
    <div id="map">Now loading</div>
    <div id="ctrl">
      <label for="file">時点</label>
      <select id="file"></select
      ><br />
      <label for="mode">表示</label>
      <select id="mode">
        <option value="1">停電軒数</option>
        <option value="2">停電軒数 / 世帯数</option>
      </select>
    </div>
    <script>
      (async function () {
        const geojson = await fetch("17.jsonl")
          .then((a) => a.text())
          .then((a) => {
            const features = a
              .trim()
              .split("\n")
              .map((t) => JSON.parse(t));
            return { type: "FeatureCollection", features: features };
          });

        let layer = null;

        const map = L.map("map", {
          preferCanvas: true,
        }).fitBounds(L.geoJSON(geojson).getBounds());

        map.zoomControl.setPosition("bottomright");
        map.attributionControl.addAttribution(
          "<a href='http://data.e-stat.go.jp/lodw/'>e-Stat 統計LOD(小地域ポリゴン+世帯数)</a>"
        );
        map.attributionControl.addAttribution(
          "<a href='http://teideninfo.tepco.co.jp/'>東京電力パワーグリッド株式会社(停電情報)</a>"
        );

        L.control
          .layers(
            {
              "淡色地図(地理院タイル)": L.tileLayer(
                "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
                {
                  attribution:
                    "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
                }
              ).addTo(map),
              "写真(地理院タイル)": L.tileLayer(
                "https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg",
                {
                  attribution:
                    "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
                }
              ),
              OpenStreetMap: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution:
                  "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors",
              }),
            },
            {},
            {
              position: "topleft",
            }
          )
          .addTo(map);

        const files = (await (await fetch("files.txt")).text()).trim().split("\n");
        for (const file of files) {
          let label = file.substring(0, 4);
          label += "-" + file.substring(4, 6);
          label += "-" + file.substring(6, 8);
          label += " " + file.substring(8, 10);
          label += ":" + file.substring(10, 12);
          $("#file")
            .append(
              $("<option/>", {
                value: file,
              }).text(label)
            )
            .val(file);
        }

        const update = async function () {
          if (layer !== null) map.removeLayer(layer);
          const file = $("#file").val();
          const mode = $("#mode").val();
          const text = await (await fetch(file)).text();

          for (const f of geojson.features) {
            f.properties.count = 0;
            f.properties.color = 0;
            f.properties.label = f.properties.fullname;
          }

          const mapping = {
            "石川県/珠洲市/狼煙新町": "石川県/珠洲市/狼煙町",
            "石川県/輪島市/縄又町": "石川県/輪島市/繩又町",
            "石川県/輪島市/門前町鍛冶屋": "石川県/輪島市/門前町鍛治屋",
            "石川県/能登町/字滝之坊": "石川県/能登町/字滝ノ坊",
            //"石川県/輪島市/三井町仁行": "石川県/輪島市/三井町下仁行",
            //"石川県/輪島市/マリンタウン": "石川県/輪島市/河井町",
            //"石川県/能登町/字宇出津山分": "石川県/鳳珠郡/能登町/字宇出津大平",
          };
          const split = {
            "石川県/輪島市/西山町": ["石川県/輪島市/大西山町", "石川県/輪島市/小西山町"],
            //"石川県/輪島市/町野町寺山": [
            //"石川県/輪島市/町野町大寺山",
            //"石川県/輪島市/町野町佐野",
            //"石川県/輪島市/町野町若桑",
            //],
            //"石川県/輪島市/町野町南時国": ["石川県/輪島市/町野町上時国"],
          };

          let n = 0;
          for (const a of text.trim().split("\n")) {
            const b = a.split(",");
            const key = [b[2], b[3], b[4]].join("/");

            // 完全一致
            let f = geojson.features.find((f) => {
              return [key, mapping[key]].includes(f.properties.fullname);
            });
            if (f) {
              f.properties.color = "#f00";
              continue;
            }
            // ポリゴンがおおざっぱ
            f = geojson.features.find((f) => {
              const names = f.properties.fullname.split("/");
              const tail = names[names.length - 1];
              return names.includes(b[2]) && names.includes(b[3]) && b[4].startsWith(tail);
            });
            if (f) {
              f.properties.color = "#ff0";
              continue;
            }

            f = geojson.features.filter((f) => {
              if (split[key]) return split[key].includes(f.properties.fullname);
              const names = f.properties.fullname.split("/");
              const tail = names[names.length - 1];
              return names.includes(b[2]) && names.includes(b[3]) && tail.startsWith(b[4]);
            });
            if (f.length > 0) {
              f.forEach((a) => {
                a.properties.color = "#0f0";
              });
              continue;
            }
            console.log(n++, a);
          }

          layer = L.geoJSON(geojson, {
            onEachFeature: function (feature, layer) {
              layer.bindTooltip(feature.properties.label);
              layer.setStyle({
                color: "#888",
                fillColor: feature.properties.color,
                weight: 1,
                fillOpacity: 0.6,
              });
            },
          }).addTo(map);
        };
        $("#mode").change(update);
        $("#file").change(update);
        await update();
      })();
    </script>
  </body>
</html>
